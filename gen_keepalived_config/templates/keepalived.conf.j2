! Configuration File for keepalived

global_defs {
   notification_email {
     {{ global.notification_email }}
   }
   notification_email_from {{ global.notification_email_from }}
   smtp_server {{ global.smtp_server }}
   smtp_connect_timeout {{ global.smtp_connect_timeout }}
   router_id {{ global.router_id }}
}

{% for vip in vips %}
vrrp_instance {{ vip.vrrp_instance }} {
    state {{ vip.state }}
    interface {{ vip.interface | default('ens32') }}
    virtual_router_id {{ vip.virtual_router_id }}
    priority {{ vip.priority }}
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    virtual_ipaddress {
        {{ vip.vip }}
    }
}

virtual_server {{ vip.vip }} 80 {
    delay_loop 3
    lb_algo rr
    lb_kind DR
    persistence_timeout 0
    protocol TCP

{% for rs in vip.real_servers %}
    real_server {{ rs.ip }} 80 {
        weight {{ rs.weight | default(1) }}
        TCP_CHECK {
            connect_timeout 2
            nb_get_retry 2
            delay_before_retry 1
            connect_port 80
        }
    }
{% endfor %}
}
{% endfor %}